<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Luqqy Store</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-pink-50 min-h-screen">

<header class="bg-gradient-to-r from-pink-400 to-rose-500 text-white p-6 text-center shadow">
  <h1 class="text-3xl font-extrabold">Admin Luqqy Store</h1>
</header>

<div class="max-w-4xl mx-auto p-6">

  <!-- LOGIN -->
  <div id="loginBox" class="bg-white p-6 rounded-xl shadow">
    <h2 class="text-xl font-bold mb-4 text-pink-600">Login Admin</h2>

    <input id="email" type="email" placeholder="Email"
      class="w-full border p-2 rounded mb-2"/>
    <input id="password" type="password" placeholder="Password"
      class="w-full border p-2 rounded mb-4"/>
    <button id="loginBtn"
      class="w-full bg-pink-500 text-white p-2 rounded-full mb-2">Login</button>
    <button id="resetBtn"
      class="text-sm text-pink-500 underline w-full mb-2">Lupa password?</button>
    <button id="backToVisitor"
      class="w-full border border-pink-400 text-pink-500 p-2 rounded-full hover:bg-pink-50">
      â† Kembali ke Luqqy Store
    </button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden">

    <button id="logoutBtn"
      class="mb-4 bg-rose-500 text-white px-4 py-2 rounded-full">Logout</button>

    <!-- FORM TAMBAH PRODUK -->
    <div class="bg-white p-6 rounded-xl shadow mb-6">
      <h2 class="font-bold mb-4">Tambah Produk</h2>

      <input id="nama" placeholder="Nama Produk *" class="w-full border p-2 rounded mb-2">
      <textarea id="deskripsi" placeholder="Deskripsi" class="w-full border p-2 rounded mb-2"></textarea>
      <input id="link" placeholder="Link Affiliate *" class="w-full border p-2 rounded mb-2">
      <select id="kategori" class="w-full border p-2 rounded mb-4">
        <option value="">Pilih Kategori *</option>
        <option value="skincare">ğŸ’„ Skincare</option>
        <option value="fashion">ğŸ‘œ Fashion</option>
        <option value="home">ğŸ  Home & Living</option>
      </select>

      <button id="simpanBtn" class="w-full bg-pink-500 text-white p-2 rounded-full">
        Simpan Produk
      </button>
    </div>

    <!-- LIST PRODUK TERPOSTING -->
    <div class="bg-white p-6 rounded-xl shadow">
      <h2 class="font-bold mb-4 text-pink-600">Produk Terposting</h2>
      <div id="list"></div>
    </div>

  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  deleteDoc, doc, query, where, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword,
  sendPasswordResetEmail, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyAgvqSOqTr5zeGFArOWYSaUExCAlwEw2gE",
  authDomain: "luqqy-store.firebaseapp.com",
  projectId: "luqqy-store",
  storageBucket: "luqqy-store.firebasestorage.app",
  messagingSenderId: "157194853674",
  appId: "1:157194853674:web:936fac43307d852fedd253"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ELEMENT */
const loginBox = document.getElementById("loginBox");
const dashboard = document.getElementById("dashboard");
const list = document.getElementById("list");

const email = document.getElementById("email");
const password = document.getElementById("password");
const nama = document.getElementById("nama");
const deskripsi = document.getElementById("deskripsi");
const link = document.getElementById("link");
const kategori = document.getElementById("kategori");

/* LOGIN */
loginBtn.onclick = () => {
  signInWithEmailAndPassword(auth, email.value, password.value)
    .catch(err => alert("Login gagal: " + err.message));
};

/* RESET */
resetBtn.onclick = () => {
  if (!email.value) return alert("Masukkan email");
  sendPasswordResetEmail(auth, email.value)
    .then(() => alert("ğŸ“§ Email reset terkirim"));
};

/* BACK */
backToVisitor.onclick = () => location.href = "index.html";

/* LOGOUT */
logoutBtn.onclick = async () => {
  await signOut(auth);
  location.href = "index.html";
};

/* AUTH */
onAuthStateChanged(auth, user => {
  if (user) {
    loginBox.classList.add("hidden");
    dashboard.classList.remove("hidden");
    loadProduk();
  } else {
    loginBox.classList.remove("hidden");
    dashboard.classList.add("hidden");
  }
});

/* LOAD PRODUK */
async function loadProduk() {
  list.innerHTML = "";
  const snap = await getDocs(collection(db, "produk"));
  
  snap.forEach(d => {
    const p = d.data();
    list.innerHTML += `
      <div class="bg-pink-50 p-3 rounded mb-2 flex justify-between items-center border">
        <div>
          <b>${p.nama}</b> (${p.kategori})<br>
          <a href="${p.link}" target="_blank" class="text-blue-500 underline">${p.link}</a>
        </div>
        <button onclick="hapus('${d.id}')" class="text-red-500 text-sm">Hapus</button>
      </div>`;
  });
}

/* HAPUS PRODUK */
window.hapus = async id => {
  if (confirm("Hapus produk?")) {
    await deleteDoc(doc(db, "produk", id));
    loadProduk();
  }
};

/* SIMPAN PRODUK */
simpanBtn.onclick = async () => {
  // Mandatory validation
  if (!nama.value.trim() || !link.value.trim() || !kategori.value.trim()) {
    alert("âŒ Nama, Link, dan Kategori wajib diisi!");
    return;
  }

  // Cek duplikasi (nama + link)
  const q = query(collection(db, "produk"),
                  where("nama", "==", nama.value.trim()),
                  where("link", "==", link.value.trim()));
  const snap = await getDocs(q);
  if (!snap.empty) {
    alert("âŒ Produk dengan nama dan link yang sama sudah ada!");
    return;
  }

  try {
    await addDoc(collection(db, "produk"), {
      nama: nama.value.trim(),
      deskripsi: deskripsi.value.trim(),
      link: link.value.trim(),
      kategori: kategori.value,
      klik: 0,
      createdAt: serverTimestamp()
    });

    alert("âœ… Produk berhasil disimpan");
    nama.value = deskripsi.value = link.value = kategori.value = "";
    loadProduk();
  } catch(e) {
    alert("âŒ Gagal simpan: " + e.message);
  }
};
</script>

</body>
</html>
